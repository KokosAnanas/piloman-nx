<div class="p-4">
  <!-- Toast для уведомлений -->
  <!-- @see https://primeng.org/toast -->
  <p-toast />

  <!-- Диалог подтверждения удаления -->
  <!-- @see https://primeng.org/confirmdialog -->
  <p-confirmDialog />

  <!-- Заголовок -->
  <h1 class="text-2xl font-bold mb-4">Реестр сварных соединений</h1>

  <!-- Панель управления: Объект + Column Toggle + Добавить стык -->
  <!-- @see https://primeng.org/select#template -->
  <div class="flex flex-wrap items-center gap-2 mb-4">
    <label class="font-semibold whitespace-nowrap">Объект:</label>
    <p-select
      [options]="objects()"
      [ngModel]="selectedObject()"
      (ngModelChange)="onObjectChange($event)"
      optionLabel="objectName"
      placeholder="Выберите объект"
      [filter]="true"
      filterPlaceholder="Поиск..."
      class="w-full md:w-80"
    >
      <!-- Footer с кнопкой добавления нового объекта -->
      <ng-template pTemplate="footer">
        <div class="p-2 border-t border-surface-200 dark:border-surface-700">
          <p-button
            label="Добавить новый объект"
            icon="pi pi-plus"
            [text]="true"
            severity="secondary"
            class="w-full"
            (onClick)="showObjectDialog()"
          />
        </div>
      </ng-template>
    </p-select>

    <!-- Column Toggle -->
    <!-- @see https://primeng.org/table#column-toggle -->
    <p-multiselect
      [options]="cols"
      [(ngModel)]="selectedColumns"
      optionLabel="header"
      selectedItemsLabel="Колонки: {0}"
      placeholder="Выбрать колонки"
      class="w-54"
      [maxSelectedLabels]="2"></p-multiselect>

    <p-button
      label="Добавить стык"
      icon="pi pi-plus"
      [disabled]="isAdding() || !selectedObject()"
      [pTooltip]="!selectedObject() ? 'Сначала выберите объект' : ''"
      (onClick)="startAdding()"
    />
  </div>

  <!-- Индикатор загрузки -->
  @if (loading()) {
    <div class="text-center p-4">Загрузка данных...</div>
  }

  <!-- Контейнер таблицы с фиксированной шириной -->
  <!-- Arbitrary variants для PrimeNG: убираем width:100%, делаем fit-content -->
  <div class="card-border w-fit max-w-full overflow-hidden">
    <div class="overflow-x-auto p-8 [&_.p-datatable]:w-fit [&_.p-datatable-table-container]:w-fit [&_.p-datatable-table]:w-fit">
      <!-- Таблица PrimeNG: table-fixed -->
      <!-- @see https://primeng.org/table#basic -->
      <!-- Таблица с поддержкой выбора строки для перехода на дашборд -->
      <!-- @see https://primeng.org/table#single-row-selection -->
      <p-table
        [value]="tableData()"
        [loading]="loading()"
        [paginator]="welds().length > 100"
        [rows]="100"
        [rowsPerPageOptions]="[50, 100, 150, 200]"
        tableStyleClass="table-fixed"
        [rowHover]="true"
        selectionMode="single"
        [(selection)]="selectedWeld"
        dataKey="id"
        [metaKeySelection]="false"
        (onRowSelect)="onRowSelect($event)"
      >
      <ng-template pTemplate="header">
        <tr>
          <!-- Действия — первая колонка -->
          <th class="w-[80px] min-w-[80px] max-w-[80px] text-center">
            <div class="min-w-0 w-full"></div>
          </th>
          @for (col of selectedColumns; track col.field) {
            <th [ngClass]="col.widthClass" class="text-center">
              <div class="min-w-0 w-full">{{ col.header }}</div>
            </th>
          }
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-row>
        <!-- Draft строка (форма добавления) -->
        @if (row._isDraft) {
          <tr [formGroup]="newRowForm" class="bg-primary-50">
            <!-- Действия: Сохранить / Отмена — первая колонка -->
            <td class="w-[80px] min-w-[80px] max-w-[80px]">
              <div class="min-w-0 w-full flex gap-1 justify-center">
                <p-button
                  icon="pi pi-check"
                  size="small"
                  [disabled]="newRowForm.invalid || isSaving()"
                  [loading]="isSaving()"
                  (onClick)="saveWeld()"
                />
                <p-button
                  icon="pi pi-times"
                  size="small"
                  severity="secondary"
                  [disabled]="isSaving()"
                  (onClick)="cancelAdding()"
                />
              </div>
            </td>
            @for (col of selectedColumns; track col.field) {
              <td [ngClass]="col.widthClass" class="px-1">
                <div class="min-w-0 w-full">
                  @switch (col.field) {
                    @case ('weldNumber') {
                      <input
                        pInputText
                        formControlName="weldNumber"
                        placeholder="ШС-001"
                        class="w-full min-w-0"
                        [ngClass]="{'ng-invalid ng-dirty': isFieldInvalid('weldNumber')}"
                      />
                    }
                    @case ('diameter') {
                      <p-inputnumber
                        formControlName="diameter"
                        [min]="1"
                        placeholder="219"
                        class="w-full min-w-0"
                        inputStyleClass="w-full min-w-0"
                        [ngClass]="{'ng-invalid ng-dirty': isFieldInvalid('diameter')}"></p-inputnumber>
                    }
                    @case ('thickness1') {
                      <p-inputnumber
                        formControlName="thickness1"
                        [min]="0.1"
                        [minFractionDigits]="1"
                        [maxFractionDigits]="2"
                        placeholder="8"
                        class="w-full min-w-0"
                        inputStyleClass="w-full min-w-0"
                        [ngClass]="{'ng-invalid ng-dirty': isFieldInvalid('thickness1')}"></p-inputnumber>
                    }
                    @case ('thickness2') {
                      <p-inputnumber
                        formControlName="thickness2"
                        [min]="0.1"
                        [minFractionDigits]="1"
                        [maxFractionDigits]="2"
                        placeholder="-"
                        class="w-full min-w-0"
                        inputStyleClass="w-full min-w-0"></p-inputnumber>
                    }
                    @case ('qualityLevel') {
                      <p-select
                        formControlName="qualityLevel"
                        [options]="qualityLevelOptions"
                        placeholder="Выбрать"
                        class="w-full min-w-0"
                      />
                    }
                    @case ('weldDate') {
                      <p-datepicker
                        formControlName="weldDate"
                        dateFormat="dd.mm.yy"
                        placeholder="дд.мм.гггг"
                        class="w-full min-w-0"></p-datepicker>
                    }
                    @case ('weldingProcess') {
                      <p-select
                        formControlName="weldingProcess"
                        [options]="weldingProcessOptions"
                        placeholder="Выбрать"
                        class="w-full min-w-0"
                      />
                    }
                    @case ('joint') {
                      <p-select
                        formControlName="joint"
                        [options]="jointOptions"
                        placeholder="Выбрать"
                        class="w-full min-w-0"
                      />
                    }
                    @case ('testMethods') {
                      <p-multiselect
                        formControlName="testMethods"
                        [options]="testMethodsOptions"
                        placeholder="Выбрать"
                        class="w-full min-w-0"></p-multiselect>
                    }
                    @case ('conclusion') {
                      <p-select
                        formControlName="conclusion"
                        [options]="conclusionOptions"
                        placeholder="Выбрать"
                        class="w-full min-w-0"
                      />
                    }
                    @case ('weldStatus') {
                      <p-select
                        formControlName="weldStatus"
                        [options]="statusOptions"
                        placeholder="Выбрать"
                        class="w-full min-w-0"
                      />
                    }
                    @case ('notes') {
                      <input
                        pInputText
                        formControlName="notes"
                        placeholder="Примечание"
                        class="w-full min-w-0"
                      />
                    }
                  }
                </div>
              </td>
            }
          </tr>
        } @else {
          <!-- Обычная строка данных с подсветкой при наведении -->
          <!-- pSelectableRow делает строку выбираемой для onRowSelect -->
          <tr [pSelectableRow]="row" class="cursor-pointer hover:bg-surface-100 dark:hover:bg-surface-800">
            <!-- Действия — первая колонка -->
            <td class="w-[80px] min-w-[80px] max-w-[80px]">
              <div class="min-w-0 w-full flex items-center justify-center">
                <!-- Кнопка удаления стыка -->
                <!-- @see https://primeng.org/button -->
                <!-- stopPropagation предотвращает переход на дашборд при клике -->
                <p-button
                  icon="pi pi-trash"
                  size="small"
                  severity="secondary"
                  [disabled]="deletingId() === (row.id ?? row._id) || isSaving() || isAdding()"
                  [loading]="deletingId() === (row.id ?? row._id)"
                  (onClick)="onDeleteWeld(row); $event.stopPropagation()"
                />
              </div>
            </td>
            @for (col of selectedColumns; track col.field) {
              <td [ngClass]="col.widthClass">
                <!-- line-clamp-2: перенос до 2 строк, потом троеточие -->
                <div class="min-w-0 w-full overflow-hidden line-clamp-2 break-words text-center">
                  {{ formatCellValue(row, col.field) }}
                </div>
              </td>
            }
          </tr>
        }
      </ng-template>

      <!-- Пустая таблица (когда нет данных и не добавляем) -->
      <ng-template pTemplate="emptymessage">
        <tr>
          <td [attr.colspan]="selectedColumns.length + 1" class="text-center p-4">
            @if (!selectedObject()) {
              Выберите или создайте объект строительства для начала работы.
            } @else {
              Нет данных. Нажмите «Добавить стык» для создания записи.
            }
          </td>
        </tr>
      </ng-template>
      </p-table>
    </div>
  </div>

  <!-- Диалог создания объекта строительства -->
  <!-- @see https://primeng.org/dialog -->
  <p-dialog
    header="Новый объект строительства"
    [(visible)]="isObjectDialogVisible"
    [modal]="true"
    [style]="{ width: '90vw', maxWidth: '500px' }"
    [draggable]="false"
    [resizable]="false"
  >
    <div [formGroup]="objectForm" class="flex flex-col gap-4">
      <!-- Название объекта -->
      <div class="flex flex-col gap-2">
        <label for="objectName" class="font-semibold">Название объекта *</label>
        <input
          id="objectName"
          pInputText
          formControlName="objectName"
          placeholder="Например: Газопровод Ду 500 участок 1"
          class="w-full"
          [ngClass]="{'ng-invalid ng-dirty': isObjectFieldInvalid('objectName')}"
        />
      </div>

      <!-- Подрядчик -->
      <div class="flex flex-col gap-2">
        <label for="contractor" class="font-semibold">Подрядчик *</label>
        <input
          id="contractor"
          pInputText
          formControlName="contractor"
          placeholder="Например: ООО СтройМонтаж"
          class="w-full"
          [ngClass]="{'ng-invalid ng-dirty': isObjectFieldInvalid('contractor')}"
        />
      </div>

      <!-- Заказчик -->
      <div class="flex flex-col gap-2">
        <label for="customer" class="font-semibold">Заказчик *</label>
        <input
          id="customer"
          pInputText
          formControlName="customer"
          placeholder="Например: ПАО Газпром"
          class="w-full"
          [ngClass]="{'ng-invalid ng-dirty': isObjectFieldInvalid('customer')}"
        />
      </div>
    </div>

    <!-- Footer диалога -->
    <ng-template pTemplate="footer">
      <div class="flex justify-end gap-2">
        <p-button
          label="Отмена"
          severity="secondary"
          (onClick)="isObjectDialogVisible.set(false)"
        />
        <p-button
          label="Сохранить"
          icon="pi pi-check"
          [disabled]="objectForm.invalid"
          (onClick)="saveObject()"
        />
      </div>
    </ng-template>
  </p-dialog>
</div>
